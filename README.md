# Excel批量处理工具

这是一个用于批量处理Excel文件的Python工具。它可以对指定文件夹中的所有Excel文件应用相同的计算公式，并将结果写入指定的列。

## 功能特点

- 支持批量处理多个Excel文件
- 支持自定义计算公式
- 支持多工作表处理
- 自动错误处理和报告

## 安装要求

- Python 3.8 或更高版本
- Poetry 包管理器

## 安装步骤

1. 克隆项目到本地
2. 在项目根目录运行以下命令安装依赖：
   ```bash
   brew install python@3.10
   poetry env use python3.10
   poetry lock --no-cache --regenerate
   poetry install
   ```

## 使用方法

1. 运行程序：

   第一步 转化业务文件，将xls格式转化为xlsx文件

   ```bash
   poetry run convert
   ```

   第二步 处理模版文件，解决文件模版单元格问题

   ```bash
   poetry run format
   ```

   第三步 将处理之后的模版文件导入到 数据库，这时需要设置表名称  
   .env文件
   COLLECTION_NAME="yuanlao"

   ```bash
   poetry run insert_mongodb
   ```

   第四步 处理主文件

   ```bash
   poetry run process
   ```

2. 按照提示输入：
   - Excel文件所在文件夹路径
   - 计算公式（使用列字母，如 A*B）
   - 输出列（字母）

## 示例

如果要在Excel中计算：赔偿金额 = 投保面积 × 赔偿系数
- 投保面积在A列
- 赔偿系数在B列
- 结果要输出到C列

则计算公式输入：A*B

## 注意事项

- 确保Excel文件未被其他程序打开
- 建议在处理前备份原始文件
- 公式中只能使用基本的数学运算符（+、-、*、/）

----------------------------------------------------------------------------------------------------------------

需求描述：

第一个表是需要用到的表，P列（空白表头默认为赔款金额）需要用G列（表头投保面积）*17生成得到的数据，根据表1(表格文件名称)行政村名称在表2中查找B列（表头村委）数据找到对应的行政村，将表2 C列（表头出险时间）数据填充到表1H列（表头出险时间），根据表2中F列（表头农户名称），在表1中查找C列（表头被保险人）数据，找到对应值标黄表1整行数据，将表2中M列（表头损失程度）数据填充到已匹配的表1M列（表头损失程度），表1M列（表头损失程度）剩余空白数据填充表2N列（表头相同报损程度平均损失率）对应数据。

----------------------------------------------------------------------------------------------------------------

关键提示词：

实现一个python脚本，批量处理文件，需要根据文件名在 mongodb 中查找数据，查找规则如下：
首先从文件名中提取行政村关键字，比如：文件名“边李村委会_231414116232025000250”，取“边李村”为新政村
在mongodb中查找到 village 相匹配的字段，拿到所有的数据，数据结构为:[data]
遍历文件中的所有列，如果存在 被保险人 === farmer_name，在“损失程度”一列数据填写为：data中的loss_percentage字段，并将这一行的背景色设置为浅黄色，如果条件不匹配，“损失程度”一列填写 任意data中的avg_loss_same_level字段

损失程度 数据保存3位小数，写成百分比

对文件的描述：
第五行是excel表格的表头
在第五行表头，新增一列 “赔款金额”
遍历文件中的所有列，在 “赔款金额” 这一列填写：投保面积 * 17（固定值，需要定义变量）

代码需要导出一个main函数
如果文件中这一行的数据为空，就不处理
注意：
表格中的表头中，字段可能存在空格、换行符等特殊字段，会出现字段不匹配问题

mongodb 对应的表：
mongodb_uri = "mongodb://localhost:27017/"
db_name = "agricultural_insurance"
collection_name = "loss_records"

需要处理的文件路径
path = "/Users/a1/理赔文件/_data/" # Directory containing the Excel files
output_path = "/Users/a1/理赔文件/_deal_data/" 

不需要传任何参数，都在main函数中 作为变量定义

----------------------------------------------------------------------------------------------------------------

样式提示词：

按照新的提示词，继续修改代码，用汉语

修改代码，加入样式设定，样式修改单独抽离出一个函数处理，用汉语写注释

前三行合并单元格，字体大小为24，加粗，宽度以内容多少做适配
第四行合并单元格
第五行和第六行纵向合并单元格，作为表格表头，字体大小12 并加粗
表格每一列 宽度设定为 12，“身份证号码”列为 20
所有的单元格文字居中





